<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多周期虚拟货币价格监测系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #283593;
            --positive: #4caf50;
            --negative: #f44336;
            --warning: #ff9800;
            --card-bg: #ffffff;
            --text: #333333;
            --border: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--text);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: var(--secondary);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background-color: var(--primary);
            transform: translateY(-2px);
        }

        button#soundToggle {
            background-color: var(--positive);
        }

        button#soundToggle.muted {
            background-color: var(--negative);
        }

        .period-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 8px 15px;
            background-color: #e0e0e0;
            color: #333;
        }

        .period-btn.active {
            background-color: var(--secondary);
            color: white;
        }

        .alerts-panel {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }

        .alerts-panel.active {
            display: block;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffeaa7; }
            100% { background-color: #fff3cd; }
        }

        .alert-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #856404;
        }

        .coins-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .coin-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--primary);
        }

        .coin-card:hover {
            transform: translateY(-5px);
        }

        .coin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .coin-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .coin-icon {
            font-size: 1.5rem;
        }

        .coin-symbol {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .price {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .price-up {
            color: var(--positive);
        }

        .price-down {
            color: var(--negative);
        }

        .change {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
        }

        .change.positive {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--positive);
        }

        .change.negative {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--negative);
        }

        .macd-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .macd-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .macd-periods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .macd-period {
            padding: 8px;
            border-radius: 5px;
            background-color: #f5f5f5;
        }

        .macd-period-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .macd-period-values {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }

        .macd-period-values div {
            text-align: center;
        }

        .macd-status {
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            font-weight: 600;
            margin-top: 10px;
        }

        .macd-status.normal {
            background-color: rgba(33, 150, 243, 0.1);
            color: #1976d2;
        }

        .macd-status.warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }

        .macd-status.alert {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--negative);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .chart-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .coins-grid {
                grid-template-columns: 1fr;
            }
            
            .controls, .period-selector {
                flex-direction: column;
                align-items: center;
            }
            
            button, .period-btn {
                width: 100%;
                justify-content: center;
            }
            
            .macd-periods {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> 多周期虚拟货币价格监测系统</h1>
            <p class="subtitle">实时监控BTC、ETH、SOL价格与多周期MACD指标</p>
        </header>

        <div class="controls">
            <button id="startMonitoring"><i class="fas fa-play"></i> 开始监测</button>
            <button id="stopMonitoring"><i class="fas fa-stop"></i> 停止监测</button>
            <button id="soundToggle"><i class="fas fa-volume-up"></i> 声音警报: 开启</button>
            <button id="testAlarm"><i class="fas fa-bell"></i> 测试警报</button>
        </div>

        <div class="period-selector" id="periodSelector">
            <!-- 周期按钮将通过JS动态生成 -->
        </div>

        <div class="alerts-panel" id="alertsPanel">
            <div class="alert-title">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>MACD背离警报</h3>
            </div>
            <div id="alertMessage">监测到MACD背离情况！</div>
        </div>

        <div class="coins-grid" id="coinsGrid">
            <!-- 货币卡片将通过JS动态生成 -->
        </div>

        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>

        <footer>
            <p>数据来源: Binance API | 本页面仅提供信息参考，不构成投资建议</p>
        </footer>
    </div>

    <audio id="alertSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/259/259-preview.mp3" type="audio/mpeg">
    </audio>

    <script>
        // 配置
        const config = {
            updateInterval: 10000, // 10秒更新一次
            symbols: ['BTCUSDT', 'ETHUSDT', 'SOLUSDT'],
            periods: [
                { name: '2分钟', value: '2m', interval: '2m', limit: 100 },
                { name: '5分钟', value: '5m', interval: '5m', limit: 100 },
                { name: '15分钟', value: '15m', interval: '15m', limit: 100 },
                { name: '30分钟', value: '30m', interval: '30m', limit: 100 },
                { name: '1小时', value: '1h', interval: '1h', limit: 100 },
                { name: '4小时', value: '4h', interval: '4h', limit: 100 },
                { name: '12小时', value: '12h', interval: '12h', limit: 100 },
                { name: '1天', value: '1d', interval: '1d', limit: 100 },
                { name: '1周', value: '1w', interval: '1w', limit: 100 },
                { name: '1月', value: '1M', interval: '1M', limit: 100 }
            ],
            macdSettings: {
                fastPeriod: 12,
                slowPeriod: 26,
                signalPeriod: 9
            },
            currentPeriod: '1h', // 默认显示1小时周期
            soundEnabled: true
        };

        // 状态管理
        const state = {
            monitoring: false,
            intervalId: null,
            priceHistory: {},
            klineData: {},
            macdHistory: {},
            previousMacd: {},
            divergenceAlerts: {}
        };

        // DOM 元素
        const coinsGrid = document.getElementById('coinsGrid');
        const periodSelector = document.getElementById('periodSelector');
        const alertsPanel = document.getElementById('alertsPanel');
        const alertMessage = document.getElementById('alertMessage');
        const alertSound = document.getElementById('alertSound');
        const startBtn = document.getElementById('startMonitoring');
        const stopBtn = document.getElementById('stopMonitoring');
        const soundToggle = document.getElementById('soundToggle');
        const testAlarmBtn = document.getElementById('testAlarm');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            // 初始化状态
            config.symbols.forEach(symbol => {
                state.priceHistory[symbol] = [];
                state.klineData[symbol] = {};
                state.macdHistory[symbol] = {};
                state.previousMacd[symbol] = {};
                state.divergenceAlerts[symbol] = {};
                
                // 为每个周期初始化数据
                config.periods.forEach(period => {
                    state.klineData[symbol][period.value] = [];
                    state.macdHistory[symbol][period.value] = [];
                    state.previousMacd[symbol][period.value] = { histogram: 0 };
                    state.divergenceAlerts[symbol][period.value] = false;
                });
            });

            // 创建周期选择器
            createPeriodSelector();
            
            // 创建货币卡片
            createCoinCards();
            
            // 初始数据加载
            updateAllPrices();
        }

        function createPeriodSelector() {
            config.periods.forEach(period => {
                const btn = document.createElement('button');
                btn.className = `period-btn ${period.value === config.currentPeriod ? 'active' : ''}`;
                btn.textContent = period.name;
                btn.dataset.period = period.value;
                
                btn.addEventListener('click', function() {
                    // 更新当前周期
                    config.currentPeriod = this.dataset.period;
                    
                    // 更新按钮状态
                    document.querySelectorAll('.period-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 更新显示
                    updateMACDDisplay();
                });
                
                periodSelector.appendChild(btn);
            });
        }

        function setupEventListeners() {
            startBtn.addEventListener('click', startMonitoring);
            stopBtn.addEventListener('click', stopMonitoring);
            soundToggle.addEventListener('click', toggleSound);
            testAlarmBtn.addEventListener('click', testAlarm);
        }

        function createCoinCards() {
            const coinData = {
                'BTCUSDT': { name: 'Bitcoin', icon: 'fab fa-btc' },
                'ETHUSDT': { name: 'Ethereum', icon: 'fab fa-ethereum' },
                'SOLUSDT': { name: 'Solana', icon: 'fas fa-circle' }
            };

            config.symbols.forEach(symbol => {
                const coin = coinData[symbol];
                const card = document.createElement('div');
                card.className = 'coin-card';
                card.id = `${symbol}-card`;
                
                card.innerHTML = `
                    <div class="coin-header">
                        <div class="coin-name">
                            <i class="coin-icon ${coin.icon}"></i>
                            <div>
                                <div class="coin-symbol">${coin.name}</div>
                                <div>${symbol}</div>
                            </div>
                        </div>
                        <div class="last-update">刚刚更新</div>
                    </div>
                    <div class="price" id="${symbol}-price">--</div>
                    <div class="change" id="${symbol}-change">--</div>
                    
                    <div class="macd-info">
                        <div class="macd-title">
                            <i class="fas fa-wave-square"></i> MACD 指标 - <span id="${symbol}-current-period">1小时</span>
                        </div>
                        <div class="macd-values">
                            <div class="macd-value">
                                <div>MACD线</div>
                                <div id="${symbol}-macd">--</div>
                            </div>
                            <div class="macd-value">
                                <div>信号线</div>
                                <div id="${symbol}-signal">--</div>
                            </div>
                            <div class="macd-value">
                                <div>柱状图</div>
                                <div id="${symbol}-histogram">--</div>
                            </div>
                        </div>
                        <div class="macd-periods" id="${symbol}-periods">
                            <!-- 多周期MACD信息将通过JS动态生成 -->
                        </div>
                        <div class="macd-status normal" id="${symbol}-status">
                            状态: 正常
                        </div>
                    </div>
                `;
                
                coinsGrid.appendChild(card);
                
                // 创建多周期MACD显示
                createPeriodMACDDisplay(symbol);
            });
        }

        function createPeriodMACDDisplay(symbol) {
            const periodsContainer = document.getElementById(`${symbol}-periods`);
            
            config.periods.forEach(period => {
                const periodElement = document.createElement('div');
                periodElement.className = 'macd-period';
                periodElement.id = `${symbol}-${period.value}-period`;
                
                periodElement.innerHTML = `
                    <div class="macd-period-header">
                        <span>${period.name}</span>
                        <span class="period-status" id="${symbol}-${period.value}-status">正常</span>
                    </div>
                    <div class="macd-period-values">
                        <div>MACD: <span id="${symbol}-${period.value}-macd">--</span></div>
                        <div>信号: <span id="${symbol}-${period.value}-signal">--</span></div>
                        <div>柱: <span id="${symbol}-${period.value}-histogram">--</span></div>
                    </div>
                `;
                
                periodsContainer.appendChild(periodElement);
            });
        }

        async function updateAllPrices() {
            try {
                for (const symbol of config.symbols) {
                    await updatePriceData(symbol);
                    await updateKlineData(symbol);
                }
            } catch (error) {
                console.error('更新价格时出错:', error);
            }
        }

        async function updatePriceData(symbol) {
            try {
                // 使用币安API获取价格数据
                const response = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`);
                const data = await response.json();
                
                // 更新价格显示
                const price = parseFloat(data.lastPrice);
                const priceChange = parseFloat(data.priceChange);
                const priceChangePercent = parseFloat(data.priceChangePercent);
                
                document.getElementById(`${symbol}-price`).textContent = formatPrice(price);
                document.getElementById(`${symbol}-change`).textContent = 
                    `${priceChange >= 0 ? '+' : ''}${priceChangePercent.toFixed(2)}%`;
                
                // 设置价格颜色
                const priceElement = document.getElementById(`${symbol}-price`);
                const changeElement = document.getElementById(`${symbol}-change`);
                
                if (priceChangePercent >= 0) {
                    priceElement.className = 'price price-up';
                    changeElement.className = 'change positive';
                } else {
                    priceElement.className = 'price price-down';
                    changeElement.className = 'change negative';
                }
                
                // 更新最后更新时间
                document.querySelector(`#${symbol}-card .last-update`).textContent = 
                    `更新: ${new Date().toLocaleTimeString()}`;
                
            } catch (error) {
                console.error(`获取 ${symbol} 数据时出错:`, error);
                document.getElementById(`${symbol}-price`).textContent = '错误';
                document.getElementById(`${symbol}-change`).textContent = '--';
            }
        }

        async function updateKlineData(symbol) {
            try {
                for (const period of config.periods) {
                    const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${period.interval}&limit=${period.limit}`);
                    const klines = await response.json();
                    
                    // 提取收盘价
                    const closes = klines.map(k => parseFloat(k[4]));
                    state.klineData[symbol][period.value] = closes;
                    
                    // 计算MACD
                    calculateMACD(symbol, period.value);
                }
            } catch (error) {
                console.error(`获取 ${symbol} K线数据时出错:`, error);
            }
        }

        // 优化的EMA计算函数
        function calculateEMA(prices, period) {
            if (prices.length < period) {
                return Array(prices.length).fill(0);
            }
            
            const k = 2 / (period + 1);
            const emaValues = [prices[0]]; // 第一天的EMA就是当天的收盘价
            
            for (let i = 1; i < prices.length; i++) {
                // EMA = (收盘价 - 前一日EMA) * 平滑系数 + 前一日EMA
                const ema = (prices[i] * k) + (emaValues[i-1] * (1 - k));
                emaValues.push(ema);
            }
            
            return emaValues;
        }

        function calculateMACD(symbol, period) {
            const prices = state.klineData[symbol][period];
            
            if (prices.length < config.macdSettings.slowPeriod) {
                // 数据不足计算MACD
                console.log(`${symbol} ${period}: 数据不足，无法计算MACD`);
                return;
            }
            
            try {
                // 计算EMA
                const fastEMA = calculateEMA(prices, config.macdSettings.fastPeriod);
                const slowEMA = calculateEMA(prices, config.macdSettings.slowPeriod);
                
                // MACD线 = 快EMA - 慢EMA
                const macdLine = fastEMA[fastEMA.length - 1] - slowEMA[slowEMA.length - 1];
                
                // 计算信号线 (MACD的EMA)
                // 获取最近的一些MACD值来计算信号线
                const macdValues = [];
                const startIndex = Math.max(0, fastEMA.length - 20); // 使用最近20个点
                
                for (let i = startIndex; i < fastEMA.length; i++) {
                    macdValues.push(fastEMA[i] - slowEMA[i]);
                }
                
                const signalLineValues = calculateEMA(macdValues, config.macdSettings.signalPeriod);
                const signalLine = signalLineValues[signalLineValues.length - 1];
                
                // 柱状图
                const histogram = macdLine - signalLine;
                
                // 更新显示 - 确保即使值很小也显示
                if (period === config.currentPeriod) {
                    document.getElementById(`${symbol}-macd`).textContent = macdLine.toFixed(6);
                    document.getElementById(`${symbol}-signal`).textContent = signalLine.toFixed(6);
                    document.getElementById(`${symbol}-histogram`).textContent = histogram.toFixed(6);
                    document.getElementById(`${symbol}-current-period`).textContent = 
                        config.periods.find(p => p.value === period).name;
                }
                
                // 更新周期显示
                document.getElementById(`${symbol}-${period}-macd`).textContent = macdLine.toFixed(6);
                document.getElementById(`${symbol}-${period}-signal`).textContent = signalLine.toFixed(6);
                document.getElementById(`${symbol}-${period}-histogram`).textContent = histogram.toFixed(6);
                
                // 检测背离
                detectDivergence(symbol, period, histogram, macdLine);
                
                // 保存MACD历史记录
                state.macdHistory[symbol][period].push({
                    timestamp: Date.now(),
                    macd: macdLine,
                    signal: signalLine,
                    histogram: histogram
                });
                
                if (state.macdHistory[symbol][period].length > 50) {
                    state.macdHistory[symbol][period].shift();
                }
                
                // 更新状态显示
                updateMACDStatus(symbol, period, histogram);
                
                // 保存当前MACD值
                state.previousMacd[symbol][period].histogram = histogram;
                state.previousMacd[symbol][period].macd = macdLine;
                
            } catch (error) {
                console.error(`计算 ${symbol} ${period} MACD时出错:`, error);
            }
        }

        function detectDivergence(symbol, period, currentHistogram, currentMacd) {
            if (state.macdHistory[symbol][period].length < 5) return;
            
            const prices = state.klineData[symbol][period];
            if (prices.length < 2) return;
            
            const currentPrice = prices[prices.length - 1];
            const previousPrice = prices[prices.length - 2];
            
            const previousHistogram = state.previousMacd[symbol][period].histogram;
            const previousMacd = state.previousMacd[symbol][period].macd;
            
            // 调试信息
            console.log(`${symbol} ${period}: 价格 ${previousPrice.toFixed(2)} -> ${currentPrice.toFixed(2)}, 柱状图 ${previousHistogram.toFixed(6)} -> ${currentHistogram.toFixed(6)}`);
            
            // 检测常规背离
            if (currentPrice > previousPrice && currentHistogram < previousHistogram) {
                // 价格创新高但MACD能量柱缩减 - 看跌背离
                triggerDivergenceAlert(symbol, period, "看跌背离", 
                    "价格创新高，但MACD能量柱缩减，可能即将回调");
            } else if (currentPrice < previousPrice && currentHistogram > previousHistogram) {
                // 价格创新低但MACD能量柱增加 - 看涨背离
                triggerDivergenceAlert(symbol, period, "看涨背离", 
                    "价格创新低，但MACD能量柱增加，可能即将反弹");
            }
            
            // 检测价格与MACD线背离
            if (state.macdHistory[symbol][period].length < 2) return;
            
            if (currentPrice > previousPrice && currentMacd < previousMacd) {
                // 价格创新高但MACD线下降 - 看跌背离
                triggerDivergenceAlert(symbol, period, "看跌背离", 
                    "价格创新高，但MACD线下降，可能即将回调");
            } else if (currentPrice < previousPrice && currentMacd > previousMacd) {
                // 价格创新低但MACD线上升 - 看涨背离
                triggerDivergenceAlert(symbol, period, "看涨背离", 
                    "价格创新低，但MACD线上升，可能即将反弹");
            }
        }

        function triggerDivergenceAlert(symbol, period, type, message) {
            const periodName = config.periods.find(p => p.value === period).name;
            
            // 显示警报面板
            alertMessage.textContent = `${symbol} (${periodName}) - ${type}: ${message}`;
            alertsPanel.classList.add('active');
            
            // 播放声音警报
            if (config.soundEnabled) {
                playAlertSound();
            }
            
            // 更新卡片状态
            state.divergenceAlerts[symbol][period] = true;
            document.getElementById(`${symbol}-${period}-status`).textContent = type;
            document.getElementById(`${symbol}-${period}-status`).parentElement.parentElement.style.backgroundColor = 
                type === "看跌背离" ? "rgba(244, 67, 54, 0.1)" : "rgba(76, 175, 80, 0.1)";
            
            // 如果当前周期是警报周期，更新主状态
            if (period === config.currentPeriod) {
                document.getElementById(`${symbol}-status`).textContent = `状态: ${type}`;
                document.getElementById(`${symbol}-status`).className = 'macd-status alert';
            }
            
            // 5秒后自动清除警报状态
            setTimeout(() => {
                alertsPanel.classList.remove('active');
                document.getElementById(`${symbol}-${period}-status`).textContent = '正常';
                document.getElementById(`${symbol}-${period}-status`).parentElement.parentElement.style.backgroundColor = '';
                
                if (period === config.currentPeriod) {
                    document.getElementById(`${symbol}-status`).className = 'macd-status normal';
                    document.getElementById(`${symbol}-status`).textContent = '状态: 正常';
                }
                
                state.divergenceAlerts[symbol][period] = false;
            }, 5000);
        }

        function updateMACDStatus(symbol, period, histogram) {
            const statusElement = document.getElementById(`${symbol}-${period}-status`);
            
            if (state.divergenceAlerts[symbol][period]) {
                statusElement.textContent = '警报';
                statusElement.parentElement.parentElement.style.backgroundColor = 'rgba(244, 67, 54, 0.1)';
            } else if (Math.abs(histogram) < 0.0001) {
                statusElement.textContent = '注意';
                statusElement.parentElement.parentElement.style.backgroundColor = 'rgba(255, 152, 0, 0.1)';
            } else {
                statusElement.textContent = '正常';
                statusElement.parentElement.parentElement.style.backgroundColor = '';
            }
            
            // 更新主状态显示（如果当前周期）
            if (period === config.currentPeriod) {
                const mainStatusElement = document.getElementById(`${symbol}-status`);
                
                if (state.divergenceAlerts[symbol][period]) {
                    mainStatusElement.className = 'macd-status alert';
                } else if (Math.abs(histogram) < 0.0001) {
                    mainStatusElement.className = 'macd-status warning';
                    mainStatusElement.textContent = '状态: 能量柱接近零轴';
                } else {
                    mainStatusElement.className = 'macd-status normal';
                    mainStatusElement.textContent = '状态: 正常';
                }
            }
        }

        function updateMACDDisplay() {
            config.symbols.forEach(symbol => {
                // 更新当前周期显示
                document.getElementById(`${symbol}-current-period`).textContent = 
                    config.periods.find(p => p.value === config.currentPeriod).name;
                
                // 重新计算当前周期的MACD显示
                if (state.klineData[symbol] && state.klineData[symbol][config.currentPeriod]) {
                    calculateMACD(symbol, config.currentPeriod);
                }
            });
        }

        function playAlertSound() {
            if (!config.soundEnabled) return;
            
            alertSound.currentTime = 0;
            alertSound.play().catch(e => {
                console.log("自动播放被阻止，请用户交互后重试");
            });
        }

        function formatPrice(price) {
            if (price >= 1000) {
                return `$${price.toFixed(2)}`;
            } else if (price >= 1) {
                return `$${price.toFixed(3)}`;
            } else {
                return `$${price.toFixed(4)}`;
            }
        }

        function startMonitoring() {
            if (state.monitoring) return;
            
            state.monitoring = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            // 立即更新一次
            updateAllPrices();
            
            // 设置定时器
            state.intervalId = setInterval(updateAllPrices, config.updateInterval);
            
            alert("监测已开始！系统将每10秒更新一次数据。");
        }

        function stopMonitoring() {
            if (!state.monitoring) return;
            
            state.monitoring = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            clearInterval(state.intervalId);
            
            alert("监测已停止！");
        }

        function toggleSound() {
            config.soundEnabled = !config.soundEnabled;
            
            if (config.soundEnabled) {
                soundToggle.innerHTML = '<i class="fas fa-volume-up"></i> 声音警报: 开启';
                soundToggle.classList.remove('muted');
            } else {
                soundToggle.innerHTML = '<i class="fas fa-volume-mute"></i> 声音警报: 关闭';
                soundToggle.classList.add('muted');
            }
        }

        function testAlarm() {
            playAlertSound();
            alertMessage.textContent = "测试警报: 这是MACD背离警报测试";
            alertsPanel.classList.add('active');
            
            setTimeout(() => {
                alertsPanel.classList.remove('active');
            }, 3000);
        }
    </script>
</body>
</html>
